[Home page](https://code-int.ornl.gov/vertex/vertex-cfd/-/wikis/home) -> [Software quality assurance](software-quality-assurance.md)

# VertexCFD Regression Testing

The regression test logic is located in `VertexCFD/regression_test` and is run on the [CI](https://code-int.ornl.gov/vertex/vertexcfd/-/pipelines) using the script [`.gitlab-ci.yml`](../../.gitlab-ci.yml). The CI is currently set to run all tests on a Anduril node (128 CPUs) every time a new commit is pushed to a branch. The numerical solution generated by VertexCFD is compared to the gold files using the Trilinos tool [`exodiff`](https://gsjaardema.github.io/seacas-docs/exo_util.pdf). [`Pytest`](https://docs.pytest.org/en/6.2.x/contents.html) is being used as the main driver.

The `VertexCFD/regression_test` directory contains the following items:
- a Python script `vertexcfd_test.py` that implements logic to set up each working directory, to run VertexCFD and to assert numerical solution against gold file using `exodiff`,
- a set of test directories that contains a Python script, a gold directory with Exodus files, and an `exodiff_file.txt` file. The Python script implements the test class with one function per test to run. Each function calls a specific input file and can support different options to pass the VertexCFD executable and the `exodiff` executable ([as a command line or from `exodiff_file.txt` file](https://gsjaardema.github.io/seacas-docs/exo_util.pdf)). The gold directory contains the VertexCFD output files that serve as gold (reference) files.

## Adding new regression tests

Adding a regression test in VertexCFD should be done with the following steps:

1. Inside `VertexCFD/regression_test` directory, duplicate an existing test directory and rename it as `test_new_name`.

2. Enter the new test directory `test_new_name` and rename the python script as `test_new_name.py`. Then, update the logic of the python script by changing the class name `class TestNewClassName`.

3. Create a function for each test to add to the regression test suite:
   ```python
    def test_new_test_name(self):
        #### Parameters to edit for each function ####
        # Parameters for VertexCFD run
        self.input_file = "XML_NAME.xml"
        vertexcfd_options = "--kokkos-threads=1"

        # Parameters for exodiff executables
        exodiff_options = "-steps last"

        #### The following code should not be modified ####
        # Run VertexCFD and call exodiff to compare to gold file
        vertexcfd_test.run_test(self, vertexcfd_options, exodiff_options)
   ```
   The input file for the test `test_new_test_name` is set by the variable `self.input_file`. Options to be passed to the VertexCFD and Exodiff executables are set by the variables `vertexcfd_options` and `exodiff_options`, respectively.

4. Add the gold file to `test_new_name/gold` for the test implemented in function `test_new_test_name` and make sure that the name of the gold file matches the name of the output file set in the XML file `self.input_file`.

5. Add the restart files (`.data` and `.dofmap`) to `test_new_name/restart` if needed. The names of the restart file should be of the form `base_input_file_read.data` and `base_input_file_read.dofmap` where `base_input_file` corresponds to the name of the input file `self.input_file` without the the format `.xml`. Please refer to `regression_test/test_tp3/` for an example of how to use restart files in regression tests.

6. Add a marker if needed based on the list of markers implemented in `regression_test/pytest.in`:
   ```python
   @pytest.mark.MARKER_NAME
   def test_new_test_name(self):
   ```

7. The last step consist of updating the list of XML file and Exodus mesh files to be copied to the build directory in `examples/CMakeLists.txt`, and update the below section `List of regression tests` with a description of the added tests.

Once all 7 steps are completed, the new test should be ready to run on the CI after committing and pushing all changes. The regression tests can be run locally by using the command line on `anduril-login02` or `narsil-login2` within the `VertexCFD` directory of the current branch: `gitlab-runner exec shell --env 'MARKERS=<MARKER>' --env 'TEST_NAMES=<TEST_NAME>regression-test`. The flag `--env` exports the variables `MARKERS` and `TEST_NAMES` to the CI environment. The `MARKERS` variable should be set to `push`, `daily`, `weekly` or `all` (see `pytest.ini` for a complete list of markers). The `TEST_NAMES` variables is used to select regression tests by names. Examples of how to use the `gitlab-runner` at the command line are provided below:
- `gitlab-runner exec shell --env 'MARKERS=push' --env 'TEST_NAMES=workbench' regression-test` will run all tests with marker `push` and whom names contain `workbench`.
- `gitlab-runner exec shell --env 'MARKERS=push' --env 'TEST_NAMES=workbench or simple_box' regression-test` will run all tests with marker `push` and whom names contain `workbench` or `simple_box`.
- `gitlab-runner exec shell --env 'MARKERS=push or serial' --env 'TEST_NAMES=simple_box' regression-test` will run all tests with markers `push` or `serial` and whom names contain `simple_box`.
- `gitlab-runner exec shell --env 'TEST_NAMES=simple_box' regression-test` will run all tests whom names contain `simple_box`.
- `gitlab-runner exec shell --env 'MARKERS=push or serial' regression-test` will run all tests with marker `push` or `serial`.

NOTE: in the current implementation, each test runs in less than 1 minute on one Anduril node.

## Failed regression tests

Regression tests that fail are automatically moved in the directory `vertexcfd/regression_failures`. If run on the CI, the directory `regression_failures` is available as an artifact for further analysis and is accessible by clicking on `Browse`, `build` and `regression_failures` from the pipeline.

The directory `regression_failures` contains one sub-directory per class with failed regression tests. Each sub-directory contains the corresponding input file, the solution file, the command file `exodiff_file.txt`, and a `diff` Exodus file between the numerical solution and the gold solution. The `diff` file is generated from `exodiff` executable.

For illustration purpose, let's assume that three input files from three different classes were modified:
- `input_file_1.xml`: the number of elements in the X direction is modified. VertexCFD will run but `exodiff` call will fail since the number of degrees of freedom will be different between the solution file and the gold file.
- `input_file_2.xml`: the XML format is invalid (missing `>` for instance) which will cause VertexCFD to fail when parsing the input file. Consequently, VertexCFD will not run and the solution file will not be generated.
- `input_file_3.xml`: the value of a parameter was changed. It will cause the numerical solution to be different of the gold file and a `diff` file will be generated.

The directory `regression_failures` will contain three sub-directories with input files, Exodus files and/or command files `exodiff_file.txt` as follows:
- `test_class_1`:
  - `exodiff_file.txt`
  - `input_file_1.xml`
  - `input_file_1_solution.exo`
- `test_class_2`:
  - `input_file_2.xml`
- `test_class_3`:
  - `exodiff_file.txt`
  - `input_file_3.xml`
  - `input_file_3_solution.exo`
  - `input_file_3_solution_diff.exo`

## Renaming variables in gold Exodus files

Under the assumption a variable name is changed in the source code, gold files have to be updated. One option is to re-run each regression test which is time consuming and not feasible within a reasonable amount of time. Another option consists of using the capabilities available in the Python wrapper `exodus3.py` of some of the Exodus libraries (Python 3 version). The Python script `rename_variable_exodus.py` was designed to replace names of variables without modifying their values with the following features:
- nodal variables and element variables can be updated.
- multiple variables can be passed to the script as a list.
- the Exodus files to update can be specified with a list of files (relative to the script).
- search and replace logic only works with exact match. If a variable name passed to the script is not found in the Exodus file, a warning message will be thrown.
- once the script completes, a full report is shown with variable names that were updated/not updated for each file.

A few examples are presented to illustrate its usage:
- Replace nodal variable names in a Exodus file:
```
python3 rename_variables_exodus.py -n velocity_0 velocity_0_new -n velocity_1 velocity_1_new test_incompressible/test_pipe_flow/gold/incompressible_2d_channel_solution.exo
```
- Replace an element variable name in files passed by using shell globbing:
```
python3 rename_variables_exodus.py -e lagrange_pressure lagrange_pressure_new test_incompressible/test_pipe_flow/gold/incompressible_2d_*.exo
```
- Replace a nodal variable name from a list of files specified at the command line:
```
python3 rename_variables_exodus.py -n velocity_0 velocity_0_new test_incompressible/test_pipe_flow/gold/incompressible_2d_channel_solution.exo test_incompressible/test_pipe_flow/gold/incompressible_2d_heated_channel_solution.exo
```

[Home page](https://code-int.ornl.gov/vertex/vertex-cfd/-/wikis/home)
